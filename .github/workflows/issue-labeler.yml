name: Issue Auto-Labeler

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  label-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Analyze and Label Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const fullText = title + ' ' + body;
            
            const labels = [];
            
            // Check for Urgent indicators
            const urgentKeywords = [
              'urgent', 'critical', 'asap', 'emergency', 'immediately',
              'blocker', 'blocking', 'broken', 'crash', 'down', 'not working',
              'production', 'security', 'vulnerability', 'bug'
            ];
            
            if (urgentKeywords.some(keyword => fullText.includes(keyword))) {
              labels.push('Urgent');
            }
            
            // Check for Feature indicators
            const featureKeywords = [
              'feature', 'enhancement', 'add', 'implement', 'improve',
              'support for', 'would like', 'could we', 'can we',
              'new', 'ability to', 'integration', 'functionality'
            ];
            
            if (featureKeywords.some(keyword => fullText.includes(keyword))) {
              labels.push('Feature');
            }
            
            // Check for Question indicators
            const questionKeywords = [
              'how', 'why', 'what', 'when', 'where', 'who',
              'question', '?', 'help', 'documentation', 'explain',
              'understand', 'clarify', 'wondering', 'confused'
            ];
            
            if (questionKeywords.some(keyword => fullText.includes(keyword))) {
              labels.push('Question');
            }
            
            // If no labels matched, add a default label
            if (labels.length === 0) {
              labels.push('Question');
            }
            
            // Apply labels to the issue
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
              
              console.log(`Applied labels: ${labels.join(', ')}`);
            }
            
            // Post a comment with analysis
            const comment = `ðŸ¤– **Automated Analysis**\n\n` +
              `This issue has been automatically analyzed and labeled as: **${labels.join(', ')}**\n\n` +
              `If you believe this categorization is incorrect, please feel free to adjust the labels manually.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: comment
            });

      - name: Create labels if they don't exist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const labelsToCreate = [
              { name: 'Urgent', color: 'D73A4A', description: 'Critical issues requiring immediate attention' },
              { name: 'Feature', color: '0E8A16', description: 'New feature requests or enhancements' },
              { name: 'Question', color: 'D876E3', description: 'Questions or requests for clarification' }
            ];
            
            for (const label of labelsToCreate) {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                  color: label.color,
                  description: label.description
                });
                console.log(`Created label: ${label.name}`);
              } catch (error) {
                if (error.status === 422) {
                  console.log(`Label ${label.name} already exists`);
                } else {
                  throw error;
                }
              }
            }
