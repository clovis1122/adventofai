<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesture-Controlled Flight Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .video-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .video-container {
            position: relative;
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1);
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }

        .gesture-status {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            text-align: center;
        }

        .gesture-indicator {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .gesture-hint {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .flight-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .search-box input::placeholder {
            color: #666;
        }

        .flight-display {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 10px;
            padding: 25px;
            min-height: 300px;
        }

        .flight-info h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .flight-details {
            display: grid;
            gap: 12px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 5px;
        }

        .detail-label {
            font-weight: bold;
            color: #764ba2;
        }

        .detail-value {
            color: #333;
        }

        .flight-counter {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 5px;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
        }

        .error {
            background: rgba(255, 0, 0, 0.2);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            text-align: center;
        }

        .open-hand {
            color: #4ade80;
        }

        .closed-hand {
            color: #fb923c;
        }

        .no-hand {
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úàÔ∏è Gesture-Controlled Flight Tracker</h1>
        <p class="subtitle">Control with your hand: Open = Previous Flight | Fist = Next Flight</p>

        <div class="main-content">
            <div class="video-section">
                <h3 style="margin-bottom: 15px;">üìπ Camera & Gesture Detection</h3>
                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                <div class="gesture-status">
                    <div class="gesture-indicator" id="gestureIndicator">üñêÔ∏è No hand detected</div>
                    <div class="gesture-hint">Show your hand to the camera</div>
                </div>
            </div>

            <div class="flight-section">
                <h3 style="margin-bottom: 15px;">üõ´ Flight Information</h3>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search flights by callsign or origin country...">
                </div>
                <div class="flight-display" id="flightDisplay">
                    <div class="loading">Loading flights...</div>
                </div>
            </div>
        </div>

        <div class="status-bar" id="statusBar">
            Initializing...
        </div>
    </div>

    <script>
        // State management
        let flights = [];
        let currentFlightIndex = 0;
        let lastGesture = null;
        let gestureDebounce = false;
        let camera = null;

        // Initialize MediaPipe Hands
        const hands = new Hands({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onHandResults);

        // Setup camera
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');

        function startCamera() {
            camera = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 640,
                height: 480
            });
            camera.start();
        }

        // Hand gesture detection
        function onHandResults(results) {
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                for (const landmarks of results.multiHandLandmarks) {
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                    drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 3});
                }

                const gesture = detectGesture(results.multiHandLandmarks[0]);
                updateGestureUI(gesture);
                handleGesture(gesture);
            } else {
                updateGestureUI(null);
            }

            canvasCtx.restore();
        }

        function detectGesture(landmarks) {
            // Calculate if fingers are extended
            const thumbTip = landmarks[4];
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const ringTip = landmarks[16];
            const pinkyTip = landmarks[20];

            const thumbBase = landmarks[2];
            const indexBase = landmarks[6];
            const middleBase = landmarks[10];
            const ringBase = landmarks[14];
            const pinkyBase = landmarks[18];

            const wrist = landmarks[0];

            // Check if fingers are extended (tip is higher than base)
            const indexExtended = indexTip.y < indexBase.y;
            const middleExtended = middleTip.y < middleBase.y;
            const ringExtended = ringTip.y < ringBase.y;
            const pinkyExtended = pinkyTip.y < pinkyBase.y;

            const extendedCount = [indexExtended, middleExtended, ringExtended, pinkyExtended].filter(Boolean).length;

            // Open hand: 3 or more fingers extended
            if (extendedCount >= 3) {
                return 'open';
            }
            // Closed fist: 0 or 1 finger extended
            else if (extendedCount <= 1) {
                return 'closed';
            }

            return null;
        }

        function updateGestureUI(gesture) {
            const indicator = document.getElementById('gestureIndicator');

            if (gesture === 'open') {
                indicator.textContent = 'üñêÔ∏è Open Hand - Previous Flight';
                indicator.className = 'gesture-indicator open-hand';
            } else if (gesture === 'closed') {
                indicator.textContent = '‚úä Fist - Next Flight';
                indicator.className = 'gesture-indicator closed-hand';
            } else {
                indicator.textContent = 'üñêÔ∏è No hand detected';
                indicator.className = 'gesture-indicator no-hand';
            }
        }

        function handleGesture(gesture) {
            if (!gesture || gestureDebounce || flights.length === 0) return;

            if (gesture !== lastGesture) {
                lastGesture = gesture;

                if (gesture === 'open') {
                    navigateFlight(-1); // Previous
                } else if (gesture === 'closed') {
                    navigateFlight(1); // Next
                }

                // Debounce to prevent rapid switching
                gestureDebounce = true;
                setTimeout(() => {
                    gestureDebounce = false;
                    lastGesture = null;
                }, 1000);
            }
        }

        // Flight data management
        async function fetchFlights() {
            try {
                updateStatus('Fetching flight data...');
                
                // Fetch all flights using CORS proxy
                const response = await fetch('https://corsproxy.io/?https://opensky-network.org/api/states/all');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Filter for flights in New York state (approximate bounding box)
                // New York coordinates: roughly 40¬∞-45¬∞N, 71¬∞-80¬∞W
                const nyFlights = data.states.filter(state => {
                    const lat = state[6]; // latitude
                    const lon = state[5]; // longitude
                    return lat && lon && 
                           lat >= 40 && lat <= 45 && 
                           lon >= -80 && lon <= -71;
                }).map((state, index) => ({
                    id: index,
                    callsign: state[1] ? state[1].trim() : 'N/A',
                    originCountry: state[2] || 'Unknown',
                    longitude: state[5] ? state[5].toFixed(4) : 'N/A',
                    latitude: state[6] ? state[6].toFixed(4) : 'N/A',
                    altitude: state[7] ? `${state[7].toFixed(0)} m` : 'N/A',
                    velocity: state[9] ? `${state[9].toFixed(2)} m/s` : 'N/A',
                    heading: state[10] ? `${state[10].toFixed(0)}¬∞` : 'N/A',
                    verticalRate: state[11] ? `${state[11].toFixed(2)} m/s` : 'N/A',
                    onGround: state[8] ? 'Yes' : 'No'
                }));

                // Get top 5 flights
                flights = nyFlights.slice(0, 5);
                
                if (flights.length === 0) {
                    // If no NY flights, show any flights
                    flights = data.states.slice(0, 5).map((state, index) => ({
                        id: index,
                        callsign: state[1] ? state[1].trim() : 'N/A',
                        originCountry: state[2] || 'Unknown',
                        longitude: state[5] ? state[5].toFixed(4) : 'N/A',
                        latitude: state[6] ? state[6].toFixed(4) : 'N/A',
                        altitude: state[7] ? `${state[7].toFixed(0)} m` : 'N/A',
                        velocity: state[9] ? `${state[9].toFixed(2)} m/s` : 'N/A',
                        heading: state[10] ? `${state[10].toFixed(0)}¬∞` : 'N/A',
                        verticalRate: state[11] ? `${state[11].toFixed(2)} m/s` : 'N/A',
                        onGround: state[8] ? 'Yes' : 'No'
                    }));
                }
                
                currentFlightIndex = 0;
                displayFlight();
                updateStatus(`Loaded ${flights.length} flights. Use gestures to navigate!`);
            } catch (error) {
                console.error('Error fetching flights:', error);
                updateStatus('Error loading flights. Please refresh the page.', true);
                document.getElementById('flightDisplay').innerHTML = `
                    <div class="error">
                        Failed to load flight data: ${error.message}
                    </div>
                `;
            }
        }

        function displayFlight() {
            const display = document.getElementById('flightDisplay');

            if (flights.length === 0) {
                display.innerHTML = '<div class="no-data">No flights available</div>';
                return;
            }

            const flight = flights[currentFlightIndex];

            display.innerHTML = `
                <div class="flight-info">
                    <h2>‚úàÔ∏è ${flight.callsign}</h2>
                    <div class="flight-details">
                        <div class="detail-row">
                            <span class="detail-label">Origin Country:</span>
                            <span class="detail-value">${flight.originCountry}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Latitude:</span>
                            <span class="detail-value">${flight.latitude}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Longitude:</span>
                            <span class="detail-value">${flight.longitude}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Altitude:</span>
                            <span class="detail-value">${flight.altitude}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Velocity:</span>
                            <span class="detail-value">${flight.velocity}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Heading:</span>
                            <span class="detail-value">${flight.heading}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vertical Rate:</span>
                            <span class="detail-value">${flight.verticalRate}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">On Ground:</span>
                            <span class="detail-value">${flight.onGround}</span>
                        </div>
                    </div>
                    <div class="flight-counter">
                        Flight ${currentFlightIndex + 1} of ${flights.length}
                    </div>
                </div>
            `;
        }

        function navigateFlight(direction) {
            currentFlightIndex = (currentFlightIndex + direction + flights.length) % flights.length;
            displayFlight();
        }

        function updateStatus(message, isError = false) {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = message;
            statusBar.style.background = isError ? 'rgba(255, 0, 0, 0.3)' : 'rgba(255, 255, 255, 0.1)';
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            if (searchTerm === '') {
                fetchFlights();
                return;
            }

            // Filter flights based on search
            const filtered = flights.filter(flight => 
                flight.callsign.toLowerCase().includes(searchTerm) ||
                flight.originCountry.toLowerCase().includes(searchTerm)
            );

            if (filtered.length > 0) {
                flights = filtered;
                currentFlightIndex = 0;
                displayFlight();
                updateStatus(`Found ${filtered.length} matching flights`);
            }
        });

        // Initialize
        window.addEventListener('load', () => {
            startCamera();
            fetchFlights();
            
            // Refresh flights every 30 seconds
            setInterval(fetchFlights, 30000);
        });
    </script>
</body>
</html>
